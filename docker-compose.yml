name: eigenfield

services:
  eigenfield_ollama:
    image: ollama/ollama:0.13.5
    container_name: eigenfield_ollama
    ports:
      - "11434:11434"
    volumes:
      - eigenfield_ollama_data:/root/.ollama
      - ./backend/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/usr/bin/bash", "/entrypoint.sh"]
    environment:
      - OLLAMA_NUM_PARALLEL=2
      - OLLAMA_MAX_LOADED_MODELS=1
      - OLLAMA_FLASH_ATTENTION=1
    restart: unless-stopped
    networks:
      - eigenfield_network

  eigenfield_backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: eigenfield_backend
    ports:
      - "9000:9000"
    volumes:
      - ./backend/app:/opt/eigen_field/app:cached
      - ./backend/data:/opt/eigen_field/data
      - ./backend/vectordb:/opt/eigen_field/vectordb
      - eigenfield_pip_cache:/root/.cache/pip
    env_file:
      - ./backend/.env
    restart: unless-stopped
    depends_on:
      - eigenfield_ollama
    networks:
      - eigenfield_network

  eigenfield_frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: eigenfield_frontend
    ports:
      - "3039:3039"
    volumes:
      - ./frontend/src:/app/src:cached
      - ./frontend/public:/app/public:cached
      - ./frontend/index.html:/app/index.html:ro
      - ./frontend/vite.config.ts:/app/vite.config.ts:ro
      - ./frontend/tsconfig.json:/app/tsconfig.json:ro
      - eigenfield_node_modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:9000
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - eigenfield_backend
    networks:
      - eigenfield_network
    restart: unless-stopped

volumes:
  eigenfield_ollama_data:
    name: eigenfield_ollama_data
  eigenfield_pip_cache:
    name: eigenfield_pip_cache
  eigenfield_node_modules:
    name: eigenfield_node_modules

networks:
  eigenfield_network:
    name: eigenfield_network
    driver: bridge